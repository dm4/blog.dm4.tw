---
layout: post
title: "è©¦è‘—å¹«è‡ªå·±çš„ç¶²ç«™åŠ ä¸Šé©—è­‰ï¼š VPN / Basic Authentication / Client Certificate / Single Sign-On"
---

ä¹‹å‰åœ¨ [ç”¨éçš„è¨˜å¸³è»Ÿé«”å€‘ - 2023 ç‰ˆ](/personal-finance-software-2023) é€™ç¯‡è£¡æåˆ°ï¼ŒæŠŠè¨˜å¸³çš„ fava è·‘èµ·ä¾†ä¹‹å¾Œï¼Œæœ‰è©¦äº†å¹¾å€‹æ–¹æ³•ä¾†åšèªè­‰ï¼Œé€™ç¯‡ä¾†è©³ç´°è¨˜éŒ„ä¸€ä¸‹ã€‚

## VPN

æ‡‰è©²æ˜¯æœ€ç›´è§€çš„ï¼Ÿ fava æ¶åœ¨å®¶è£¡çš„ server ä¸Šï¼Œæ¯æ¬¡è¦çœ‹è¨˜éŒ„çš„æ™‚å€™éƒ½é€£å›å®¶è£¡ VPN çœ‹ï¼Œç¼ºé»ä¹Ÿæ»¿æ˜é¡¯çš„ï¼Œå°±æ˜¯å¾ˆéº»ç…©â€¦â€¦é›–ç„¶å¯ä»¥åœ¨ iOS ä¸ŠåŠ ä¸€äº›æ·å¾‘è‡ªå‹•é€£ç·šï¼Œä¸éå¸¸å¸¸å¿˜è¨˜æ–·é–‹ VPN å°è‡´ç¶²è·¯ä¸ç©©ä¹Ÿæ˜¯æ»¿å›°æ“¾çš„ã€‚

æœ‰äº›å®¶ç”¨ Router æˆ–æ˜¯ NAS éƒ½å¯ä»¥æ–¹ä¾¿çš„æŠŠ VPN server è·‘èµ·ä¾†ï¼Œä¹Ÿæœ‰è©¦é [WireGuard](https://www.wireguard.com/) è¦ºå¾—æ»¿æ–¹ä¾¿çš„ï¼Œé€™ä¹Ÿæ˜¯ç‚ºä»€éº¼ä¹‹å‰æœƒç ”ç©¶ [WireGuard æ–°å¢ Client çš„è¨­å®š](/wireguard-add-client-configuration) â€¦â€¦ XD

## HTTP Basic Authentication

è¨­å®šæ»¿ç°¡å–®çš„ï¼ŒæŠŠå¸³è™Ÿå¯†ç¢¼è¨˜éŒ„åœ¨ htpasswd ï¼Œå†éä¸€å±¤ web server ä¾†æ§ç®¡æ¬Šé™ï¼Œéäº† auth ä¹‹å¾Œå† reverse proxy åˆ°çœŸæ­£çš„ fava server ã€‚

ç¼ºé»å¤§æ¦‚æ˜¯å¦‚æœèªè­‰éæœŸçš„æ™‚å€™è¦æ‰“å¯†ç¢¼å¾ˆç…©ï¼Œå°±ç®—æœ‰å¯†ç¢¼ç®¡ç†å·¥å…·ä¹Ÿæ˜¯è¦åœ¨é‚£è£¡ç­‰å€‹å…©ä¸‰ç§’çš„ Face ID ï¼Œæ€¥è‘—è¦é–‹ç¶²é çš„æ™‚å€™ç°¡ç›´åº¦æ—¥å¦‚å¹´ã€‚

## HTTP Client Certificate

è¦ç”¨ self sign client certificate çš„è¨­å®šå°±æ¯”è¼ƒè¤‡é›œäº†ï¼Œæµç¨‹å¤§æ¦‚æ˜¯ï¼š

- å…ˆç”Ÿå‡º `ca.key`
- ç”¨ `ca.key` ç”Ÿå‡º `ca.crt` ï¼Œé€™å°±æ˜¯æˆ‘å€‘è‡ªç°½æ†‘è­‰ (self sign certificate) çš„æ ¹æ†‘è­‰ (root certificate)
- ç‚ºæ¯å€‹æƒ³è¦ä½¿ç”¨çš„è¨­å‚™ç”Ÿä¸€æŠŠ `client.key` ï¼ˆç•¶ç„¶è¦é‡è¤‡ä½¿ç”¨ä¹Ÿä¸æ˜¯ä¸è¡Œï¼‰
- ç”¨ `client.key` ç”Ÿå‡º `client.csr` é€™å€‹æ˜¯è¦è®“æ ¹æ†‘è­‰ç°½åçš„ç°½åè«‹æ±‚ (certificate signing request)
- åªæœ‰æˆ‘è¦ºå¾—ç”¨ä¸­æ–‡è¬›æ ¹ã€è‡ªç°½ã€æ†‘è­‰ã€ç°½åæ¯”ä¸­æ–‡é‚„é›£çœ‹æ‡‚å—ï¼Ÿ
  - <https://www.youtube.com/watch?v=abWGRc3wsEI>
- ç”¨ `ca.key` `ca.crt` ä¾†ç°½ `client.csr` ï¼Œç”Ÿå‡º `client.crt`
- æŠŠç°½å¥½çš„ `client.crt` åŠ ä¸Šæœ¬ä¾†çš„ `client.key` æ‰“åŒ…è®Šæˆ `client.p12`
- æŠŠ `client.p12` è£åˆ°ç›®æ¨™è¨­å‚™ä¸Š

ç”¨åˆ°çš„æŒ‡ä»¤å¤§æ¦‚å°±æ˜¯ï¼š

```bash
# ca
openssl genrsa -out ca.key 4096
openssl req -new -x509 -days 3650 -key ca.key -out ca.crt

# client
openssl genrsa -out client.key 4096
openssl req -new -key client.key -out client.csr
openssl x509 -req -days 365 -in client.csr -CA ca.crt -CAkey ca.key -set_serial 01 -out client.crt
openssl pkcs12 -export -clcerts -in client.crt -inkey client.key -out client.p12
```

ç¼ºé»é™¤äº†è¨­å®šæœ‰é»éº»ç…©ä¹‹å¤–ï¼Œä¹Ÿæ²’è¾¦æ³•è‡¨æ™‚åœ¨åˆ¥çš„è£ç½®ä¸Šç€è¦½ï¼Œä¹‹å‰å‰›å¥½é‡åˆ° fava åœ¨ iOS Safari æœ‰ bugï¼Œçµæœ iOS ä¸Šçš„ Chrome æ²’è¾¦æ³•æ­£ç¢ºä½¿ç”¨è£åœ¨ç³»çµ±è£¡çš„ `client.p12` ğŸ˜¢

ä¸éè¨­å®šå®Œä¹‹å¾Œä¸ç”¨è€ƒæ…®æ‰“å¯†ç¢¼çš„å•é¡ŒçœŸçš„å¾ˆè®šï¼Œå¦‚æœæ²’æœ‰éœ€è¦åœ¨å…¶ä»–è£ç½®ä¸Šç€è¦½çš„è©±æ‡‰è©²æ˜¯é¦–é¸ï¼

## Single Sign-On (SSO)

å¾Œä¾†ä¹Ÿæƒ³è¦æ‰¾æœ‰æ²’æœ‰è¾¦æ³•å¯ä»¥ç›´æ¥é ç¾æœ‰çš„ Google å¸³è™Ÿç›´æ¥ç™»å…¥ï¼Œçœ‹åˆ°é€™ç¯‡ [OAuth2 Proxy ç‚ºä½ çš„å¾Œå°æä¾›èªè­‰](https://weii.dev/oauth2-proxy/) ä¹‹å¾Œå°±è©¦äº† [OAuth2 Proxy](https://github.com/oauth2-proxy/oauth2-proxy) ï¼Œè¨­å®šä¹Ÿæ˜¯æœ‰é»å°éº»ç…©ï¼Œä¸éæ¶å¥½ã€è¨­å®šå¥½ä¹‹å¾Œåªéœ€è¦ä¿®æ”¹ `oauth2-proxy-emails.txt` çš„å…§å®¹å°±å¯ä»¥æ–°å¢ / åˆªé™¤å¸³è™Ÿï¼Œå¦‚æœæ˜¯è¦è®“åˆ¥äººç™»å…¥ï¼Œæˆ–æ˜¯å¸¸å¸¸éœ€è¦æ–°å¢ / åˆªé™¤å¸³è™Ÿçš„è©±å¯ä»¥è©¦è©¦ï¼Œç•¶ç„¶ä¹Ÿæ˜¯éœ€è¦ä½¿ç”¨è€…éƒ½æœ‰ä¸€å€‹åœ¨ [OAuth2 Proxy / Providers](https://oauth2-proxy.github.io/oauth2-proxy/configuration/providers/) åˆ—è¡¨è£¡çš„å¸³è™Ÿå°±æ˜¯äº†ã€‚

ç”¨ OAuth2 ç™»å…¥é‚„æœ‰å€‹å¥½è™•æ˜¯ï¼šå°±ç®—è‡ªå·±çš„ OAuth2 Proxy é©—è­‰åˆ°æœŸäº†ï¼Œé‡æ–°è·‘ä¸€æ¬¡ç™»å…¥æµç¨‹åœ¨å¤§éƒ¨åˆ†çš„æ™‚å€™ä¹Ÿéƒ½ä¸ç”¨å†æ‰“å¯†ç¢¼ï¼Œç•¢ç«Ÿé€šå¸¸ç”¨åˆ°çš„æœå‹™æä¾›å•†çš„ session éƒ½æ²’é€™éº¼å®¹æ˜“éæœŸï¼Œåƒæ˜¯ç”¨ Google å¸³è™Ÿçš„è©±å°±æ˜¯é»å…©ä¸‰å€‹æŒ‰éˆ•å°±å¯ä»¥å®Œæˆç™»å…¥ã€‚

å¦å¤– fava å¯ä»¥ç”¨ `fava-sidebar-link` ä¾†æŠŠç™»å‡ºçš„é€£çµæ”¾åˆ°å´é‚Šæ¬„ä¸Šï¼Œé›–ç„¶è‡ªå·±ç”¨çš„è©±å¥½åƒå®Œå…¨ä¸æœƒéœ€è¦ç™»å‡º XD

---

è©¦éå¹¾ç¨®æ–¹å¼ä¹‹å¾Œï¼Œç›®å‰è¦ºå¾—æœ€é©åˆè‡ªå·±çš„æ–¹æ³•æ‡‰è©²æ˜¯ï¼šå…ˆç”¨ client certificate é©—è­‰ï¼Œå¦‚æœåµæ¸¬åˆ°æ²’æœ‰ client certificate çš„è©±å°±æ”¹ç”¨ OAuth2 Proxy ä¾†é©—è­‰ã€‚

å¦‚æœæ˜¯ç”¨ Nginx çš„è©±å¤§æ¦‚å°±æ˜¯æŠŠ `ssl_verify_client` è¨­æˆ `optional` ï¼Œä¹‹å¾Œå†ç”¨ `$ssl_client_verify` ç¢ºå®šæ˜¯ä¸æ˜¯æœ‰é€šéæ†‘è­‰çš„é©—è­‰ï¼Œå¦‚æœæ²’æœ‰æˆåŠŸé©—è­‰å°±å†èµ° OAuth2 Proxy é©—è­‰æµç¨‹ã€‚

å®Œå…¨ä¸ç”¨æ‰“å¯†ç¢¼å°±æ˜¯è®šå•¦ï¼
